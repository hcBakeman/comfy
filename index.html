<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood Engine | Pro Share</title>
    <style>
        /* Kaikki aiemmat tyylit säilytetty ennallaan */
        :root { --bg: #000; --ui-accent: #ff3366; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #ui-container {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 10; background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(25px);
            padding: 20px 30px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; gap: 12px; transition: all 0.5s ease; min-width: 320px;
        }
        #ui-container.manual-hidden { opacity: 0 !important; transform: translateX(-50%) translateY(50px); pointer-events: none; }
        .hint { position: absolute; top: 20px; width: 100%; text-align: center; font-size: 11px; letter-spacing: 2px; opacity: 0.4; text-transform: uppercase; z-index: 5; transition: 0.5s; }
        .mode-selector { display: flex; justify-content: center; gap: 8px; margin-bottom: 5px; }
        button { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 12px; cursor: pointer; font-size: 10px; font-weight: 700; text-transform: uppercase; transition: 0.3s; }
        button.active { background: var(--ui-accent); color: white; border-color: var(--ui-accent); box-shadow: 0 0 15px var(--ui-accent); }
        .control-row { display: flex; flex-direction: column; gap: 4px; }
        .control-row label { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-top: 5px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        input[type=range] { appearance: none; width: 100%; height: 3px; background: rgba(255,255,255,0.1); outline: none; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 12px; height: 12px; background: #fff; border-radius: 50%; cursor: pointer; }
        .switch { position: relative; display: inline-block; width: 30px; height: 16px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 10px; width: 10px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--ui-accent); }
        input:checked + .slider:before { transform: translateX(14px); }
    </style>
</head>
<body>

    <div class="hint" id="main-hint">M = Valikko | Kaikki tallentuu URL-osoitteeseen</div>
    <canvas id="canvas"></canvas>

    <div id="ui-container">
        <div class="mode-selector">
            <button onclick="changeMood('love')" id="btn-love">L'Amour</button>
            <button onclick="changeMood('fire')" id="btn-fire">Fire</button>
            <button onclick="changeMood('rain')" id="btn-rain">Rain</button>
            <button onclick="changeMood('bloom')" id="btn-bloom">Spirit Bloom</button>
        </div>

        <div class="control-row"><label>Määrä: <span id="val-count"></span></label><input type="range" id="input-count" min="1" max="300"></div>
        <div class="control-row"><label>Nopeus: <span id="val-speed"></span></label><input type="range" id="input-speed" min="0.1" max="15" step="0.1"></div>
        <div class="control-row"><label>Koko: <span id="val-size"></span></label><input type="range" id="input-size" min="1" max="100"></div>

        <div class="toggle-row">
            <label>Törmäysfysiikka</label>
            <label class="switch"><input type="checkbox" id="input-physics"><span class="slider"></span></label>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const ui = document.getElementById('ui-container');
        let width, height, particles = [];
        let time = 0;

        // URL Parametrien luku
        const params = new URLSearchParams(window.location.search);
        let config = {
            mood: params.get('m') || 'love',
            count: parseInt(params.get('c')) || 60,
            speed: parseFloat(params.get('s')) || 1.5,
            size: parseInt(params.get('z')) || 18,
            physics: params.get('f') !== '0',
            uiVisible: params.get('u') !== '0', // UUSI: u=0 piilottaa menun
            color: '#ff3366'
        };

        function updateURL() {
            const p = new URLSearchParams();
            p.set('m', config.mood); p.set('c', config.count);
            p.set('s', config.speed); p.set('z', config.size);
            p.set('f', config.physics ? '1' : '0');
            p.set('u', config.uiVisible ? '1' : '0'); // Tallennetaan UI tila
            window.history.replaceState(null, '', '?' + p.toString());
        }

        // Particle-luokka ja piirto-logiikka säilytetty ennallaan (Spirit Bloom mukana)
        class Particle {
            constructor(isInit = false) { this.init(isInit); }
            init(randomY = false) {
                this.x = Math.random() * width;
                this.y = randomY ? Math.random() * height : (config.mood === 'rain' ? -50 : height + 100);
                this.r = Math.random() * config.size + (config.mood === 'bloom' ? 20 : 4);
                this.vx = (Math.random() - 0.5) * 0.5;
                this.vy = config.mood === 'rain' ? (Math.random() * config.speed + 10) : -(Math.random() * config.speed * 0.3 + 0.2);
                this.a = Math.random() * 0.6 + 0.2;
                this.bloomPhase = Math.random() * Math.PI * 2;
                this.wobbleSpeed = Math.random() * 0.02;
            }
            update() {
                if (config.physics && config.mood !== 'bloom') {
                    for (let other of particles) {
                        if (this === other) continue;
                        let dx = this.x - other.x, dy = this.y - other.y;
                        let dist = Math.sqrt(dx*dx + dy*dy);
                        let minDist = this.r + other.r + 5;
                        if (dist < minDist) {
                            let ax = (dx / dist) * 0.1, ay = (dy / dist) * 0.1;
                            this.vx += ax; this.vy += ay;
                        }
                    }
                }
                this.x += this.vx; this.y += this.vy;
                if (this.y < -150 || this.y > height + 150) this.init();
                if (this.x < -100) this.x = width + 100;
                if (this.x > width + 100) this.x = -100;
            }
            draw() {
                ctx.globalAlpha = this.a;
                if (config.mood === 'bloom') this.drawFlower();
                else if (config.mood === 'love') this.drawHeart();
                else if (config.mood === 'fire') this.drawEmber();
                else this.drawRain();
            }
            drawEmber() {
                ctx.shadowBlur = 10; ctx.shadowColor = config.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
                ctx.fillStyle = config.color; ctx.fill(); ctx.shadowBlur = 0;
            }
            drawRain() { ctx.fillStyle = config.color; ctx.fillRect(this.x, this.y, 1, this.r * 15); }
            drawHeart() {
                let x = this.x, y = this.y, s = this.r;
                ctx.beginPath(); ctx.moveTo(x, y);
                ctx.bezierCurveTo(x-s, y-s, x-s*1.5, y+s/2, x, y+s*1.3);
                ctx.bezierCurveTo(x+s*1.5, y+s/2, x+s, y-s, x, y);
                ctx.fillStyle = config.color; ctx.fill();
            }
            drawFlower() {
                let x = this.x + Math.sin(time * this.wobbleSpeed) * 20;
                let size = this.r;
                ctx.save(); ctx.translate(x, this.y);
                ctx.rotate(time * 0.01 * config.speed + this.bloomPhase);
                let grad = ctx.createRadialGradient(0, 0, 0, 0, 0, size);
                grad.addColorStop(0, config.color); grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad; ctx.globalAlpha = this.a * (0.5 + Math.sin(time * 0.02 + this.bloomPhase) * 0.5);
                for (let i = 0; i < 6; i++) {
                    ctx.rotate((Math.PI * 2) / 6); ctx.beginPath(); ctx.moveTo(0, 0);
                    ctx.quadraticCurveTo(size, -size, size * 1.5, 0); ctx.quadraticCurveTo(size, size, 0, 0); ctx.fill();
                    ctx.strokeStyle = "rgba(255,255,255,0.1)"; ctx.stroke();
                }
                ctx.restore();
            }
        }

        function initParticles() {
            particles = [];
            let count = config.mood === 'bloom' ? Math.min(config.count, 40) : config.count;
            for (let i = 0; i < count; i++) particles.push(new Particle(true));
            updateUI();
        }

        function changeMood(m) {
            config.mood = m;
            if(m === 'love') config.color = '#ff3366';
            else if(m === 'fire') config.color = '#ff6622';
            else if(m === 'rain') config.color = '#6699ff';
            else if(m === 'bloom') config.color = '#a38dff';
            document.documentElement.style.setProperty('--ui-accent', config.color);
            document.querySelectorAll('.mode-selector button').forEach(b => b.classList.toggle('active', b.id === 'btn-'+m));
            initParticles();
            updateURL();
        }

        function toggleUI(show) {
            config.uiVisible = show;
            ui.classList.toggle('manual-hidden', !show);
            updateURL();
        }

        function updateUI() {
            ['count', 'speed', 'size'].forEach(id => {
                document.getElementById('input-' + id).value = config[id];
                document.getElementById('val-' + id).innerText = config[id];
            });
            document.getElementById('input-physics').checked = config.physics;
            ui.classList.toggle('manual-hidden', !config.uiVisible);
        }

        // Eventit
        ['count', 'speed', 'size'].forEach(id => {
            document.getElementById('input-' + id).addEventListener('input', (e) => {
                config[id] = parseFloat(e.target.value);
                document.getElementById('val-' + id).innerText = e.target.value;
                if(id === 'count') initParticles();
                updateURL();
            });
        });
        document.getElementById('input-physics').addEventListener('change', (e) => { config.physics = e.target.checked; updateURL(); });
        document.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 'm') toggleUI(!config.uiVisible); });

        function animate() {
            time++;
            ctx.fillStyle = "black";
            ctx.globalAlpha = config.mood === 'rain' ? 0.25 : 0.8;
            ctx.fillRect(0,0,width,height);
            ctx.globalAlpha = 1;
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }

        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; initParticles(); }
        window.addEventListener('resize', resize);
        
        // Aloitus
        changeMood(config.mood);
        resize();
        animate();
        setTimeout(() => document.getElementById('main-hint').style.opacity = '0', 5000);
    </script>
</body>
</html>